### 将 Lynx 集成到 macOS 平台

import { Info, CodeFold } from '@lynx';
import { Steps } from '@theme';
import { Tab, Tabs } from '@theme';
import { Link } from '@theme';
import versionJson from '../../../../../public/version.json';

<Info title="Lynx for macOS">
  - 本文假设你已熟悉原生 macOS 应用开发的基本概念。 - 你可以参考官方的
  [LynxExplorer](https://github.com/lynx-family/lynx/tree/develop/explorer/darwin/macos/lynx_explorer)
  项目。
</Info>

## 1. 依赖配置

<Steps>

### 下载或构建 LynxSDK

- 可以从 [GitHub Release](https://github.com/lynx-family/lynx/releases/latest) 下载预编译的LynxSDK。
- 解压下载的LynxSDK到你项目的目录下，比如 `thirdparty` 目录。

或者，你可以按照 [为macOS构建 Lynx Explorer](https://github.com/lynx-family/lynx/tree/develop/explorer/darwin/macos) 指南从源代码构建。

### 配置CMake

本文假设你已有一个基于CMake的macOS原生项目，并且希望集成Lynx能力。如果你使用的其它构建系统，你可以参考本文内容，并自行集成。

1. 基于你的项目，设置CMake基本配置。

```cmake title=CMakeLists.txt {17,20-30}
# Set the C++ standard to at least 17 if you are using the C++ wrapper apis of LynxSDK.
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_OBJCXX_STANDARD 17)
set(CMAKE_OBJCXX_STANDARD_REQUIRED ON)
```

2. 配置LynxSDK相关内容。

```cmake title=CMakeLists.txt {17,20-30}
set(LYNX_LIB_PATH ${CMAKE_CURRENT_SOURCE_DIR}/thirdparty/lynx) # Or your location of LynxSDK
# Set include directory of LynxSDK.
include_directories(${LYNX_LIB_PATH}/include)
# Set library of LynxSDK that needs to be linked.
target_link_libraries(${PROJECT_NAME} private ${LYNX_LIB_PATH}/lib/libLynx.dylib)
```

3. 添加自定义命令，用于在构建应用之后，拷贝必须的数据和资源到应用包。

<CodeFold height={360} toggle>

```cmake title=CMakeLists.txt {17,20-30}
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    # 创建Frameworks目录
    COMMAND mkdir -p "$<TARGET_BUNDLE_CONTENT_DIR:${PROJECT_NAME}>/Frameworks"

    # 复制lynx动态库到Frameworks目录
    COMMAND cp "${LYNX_LIB_PATH}/lib/libLynx.dylib" "$<TARGET_BUNDLE_CONTENT_DIR:${PROJECT_NAME}>/Frameworks/"

    # 创建Resources目录
    COMMAND mkdir -p "$<TARGET_BUNDLE_CONTENT_DIR:${PROJECT_NAME}>/Resources"

    # 复制bundles目录到Resources
    COMMAND cp -R "${LYNX_LIB_PATH}/bundles/" "$<TARGET_BUNDLE_CONTENT_DIR:${PROJECT_NAME}>/Resources/"

    # 复制data目录到Resources
    COMMAND cp -R "${LYNX_LIB_PATH}/data/" "$<TARGET_BUNDLE_CONTENT_DIR:${PROJECT_NAME}>/Resources/"

    COMMENT "Copying Lynx library and resources to application bundle"
)

# 设置rpath，确保应用程序能够找到内部Frameworks目录中的动态库
target_link_options(${PROJECT_NAME} PRIVATE
    "-Wl,-rpath,@executable_path/../Frameworks"
)
```

</CodeFold>

</Steps>

## 2. 环境初始化 - 可选

<Steps>

### Lynx Service 初始化

- Lynx Service 提供了宿主特性相关能力，推荐在LynxView创建之前完成 Lynx Service 的初始化。
- Lynx Service 需主动注入。

<CodeFold height={360} toggle>
```objective-c title=AppDelegate.mm {17,20-30}

#import "AppDelegate.h"
#import "ViewController.h"
#include "lynx_http_service.h"

// Implements the http service if needed.
class LynxHttpServiceImpl : public lynx::pub::LynxHttpService {
public:
LynxHttpServiceImpl() = default;
~LynxHttpServiceImpl() = default;

    void Request(std::shared_ptr<lynx::pub::LynxHttpRequest> request,
               std::shared_ptr<lynx::pub::LynxHttpResponse> response) override {
        // TODO
    }

};

@interface AppDelegate ()
@end

@implementation AppDelegate {
}

- (void)applicationDidFinishLaunching:(NSNotification \*)aNotification {
  // Register http service for lynx.fetch.
  lynx::pub::LynxServiceCenter::GetInstance().
  RegisterService(std::make_shared<LynxHttpServiceImpl>());
  }

````
</CodeFold>

<div style={{ marginBottom: 30 }} />

### LynxEnv 初始化

LynxEnv 提供了 Lynx Engine 的全局初始化接口, 请保证 LynxEnv 的初始化发生在 Lynx Engine 的任何接口调用之前。

<CodeFold height={360} toggle>
```objective-c title=AppDelegate.mm {9,12-19}

#import "AppDelegate.h"
#import "ViewController.h"
#include "lynx_env.h"
#include "lynx_http_service.h"

@interface AppDelegate ()
@end

@implementation AppDelegate {
}

- (void)applicationDidFinishLaunching:(NSNotification *)aNotification {
    // Register http service for lynx.fetch.
  lynx::pub::LynxServiceCenter::GetInstance().
    RegisterService(std::make_shared<LynxHttpServiceImpl>());

  // Initialize LynxEnv
  auto& lynx_env = lynx::pub::LynxEnv::GetInstance();
  // Enable devtool.
  lynx_env.SetDevtoolEnabled(true);
  lynx_env.SetDevtoolAppInfo("App", "LynxExplorer");
  lynx_env.SetDevtoolAppInfo("AppVersion", "1.0.0");
  // Register global native module if needed.
  lynx_env.RegisterNativeModule("ExplorerModule", ExplorerModuleCreator,
                            nullptr);
}

````

</CodeFold>

</Steps>

## 3. 渲染 LynxView

<Steps>

### 创建资源加载器

Lynx Engine 自身并没有集成下载资源的能力，因此需要宿主应用来提供 `LynxGenericResourceFetcher` 的具体实现，并在构造 `LynxView` 时注入，Lynx 会采用注入的资源加载器来获取真实的 Bundle 内容。
你可以使用多种方式获取 Bundle 的资源内容，在这里我们选择通过网络加载 Bundle 的内容。

:::note
Bundle 示例:
**https://unpkg.com/@lynx-example/hello-world/dist/main.lynx.bundle**
:::

实现 Resource Fetcher

<CodeFold height={360} toggle>
```objective-c title=GenericResourceFetcher.mm {9,12-19}

#import <Foundation/Foundation.h>
#include "lynx_generic_resource_fetcher.h"

class ExampleGenericResourceFetcher : public lynx::pub::LynxGenericResourceFetcher {
public:
void FetchResource(
std::shared_ptr<lynx::pub::LynxResourceRequest> request,
std::shared_ptr<lynx::pub::LynxResourceResponse> response) override {
const char *url_str = request->GetUrl();
NSString *ns_string = [NSString stringWithUTF8String:url_str];

     NSURL *url = [NSURL URLWithString:ns_string];
     NSMutableURLRequest *nsRequest = [NSMutableURLRequest requestWithURL:url];
     NSURLSession *session = [NSURLSession sharedSession];
     NSURLSessionDataTask *dataTask =
       [session dataTaskWithRequest:nsRequest
                  completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable nsResponse,
                                      NSError *_Nullable error) {
                    if (data && data.length > 0) {
                      response->SetCode(0);
                      response->SetData(
                          (uint8_t *)data.bytes, data.length,
                          [](uint8_t *body, size_t length, void *opaque) { CFRelease(opaque); },
                          (__bridge_retained void *)data);
                    } else {
                      response->SetCode(-1);
                      response->SetErrorMessage("error");
                    }
                    response->Complete();
                  }];

     [dataTask resume];

}
};

````
</CodeFold>

### 构造 LynxView

LynxView 是 Lynx Engine 提供的渲染基本单元，你可以快速的构造一个 LynxView，并通过设置一个NSView作为父容器将其任意添加到原生macOS的视图树上。

<CodeFold height={360} toggle>
```objective-c title=ViewController.mm {9,12-19}
#import "ViewController.h"
#include "lynx_view.h"

@interface ViewController ()
@property(nonatomic) std::shared_ptr<lynx::pub::LynxView> lynxView;
@end

@implementation ViewController {
}

- (void)viewDidLoad {
  [super viewDidLoad];

  lynx::pub::LynxView::Builder builder;
  builder.SetScreenSize(self.view.frame.size.width, self.view.frame.size.height, 1.0)
      .SetFrame(0, 0, self.view.frame.size.width, self.view.frame.size.height)
      .SetParent((__bridge NativeWindow)self.view)
  .SetGenericResourceFetcher(std::make_shared<ExampleGenericResourceFetcher>());
  _lynxView = builder.Build();
}

- (void)viewDidLayout {
  [super viewDidLayout];
  // It's necessary when resizing the Window.
  _lynxView->UpdateScreenMetrics(self.view.frame.size.width, self.view.frame.size.height,
                                 1.0);
  _lynxView->SetFrame(0, 0, self.view.frame.size.width, self.view.frame.size.height);
}

````

</CodeFold>

<div style={{ marginBottom: 30 }} />

### 渲染视图

当你完成以上步骤之后，已经完成了 LynxView 创建与资源读取的全部工作，调用 `lynxView->LoadTemplate` 方法，即可将对应的 Bundle 内容渲染到 LynxView 视图上。

<CodeFold height={360} toggle>
```objective-c title=ViewController.mm {9,12-19}
#import "ViewController.h"
#include "lynx_view.h"

@interface ViewController ()
@property(nonatomic) std::shared_ptr<lynx::pub::LynxView> lynxView;
@end

@implementation ViewController {
}

- (void)loadTemplate {
  // Call `loadTemplate` where you want.
  auto meta_data = std::make_shared<lynx::pub::LynxLoadMeta>();
  meta_data->SetUrl("https://unpkg.com/@lynx-example/hello-world/dist/main.lynx.bundle");
  \_lynxView->LoadTemplate(meta_data);
  }

```
</CodeFold>

然后你将在屏幕上看到如下内容：

<center>
  <img src="https://lf-lynx.tiktok-cdns.com/obj/lynx-artifacts-oss-sg/plugin/static/hello-world-showcase-macos.jpg" width="800" />
</center>

</Steps>

恭喜你，现在你现在已经完成了 Lynx Engine 集成的全部工作！

## 4. 进入 Lynx 世界

现在你已经将 Lynx 集成到你的应用中了。请参考[开发](/guide/start/quick-start)和[调试](/guide/devtool/panels)文档进一步在 Lynx 的世界里遨游吧！
```
