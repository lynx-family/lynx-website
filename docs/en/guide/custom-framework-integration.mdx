import { Details, PlatformTabs, Go, VideoList } from '@lynx';
import { PackageManagerTabs, Steps } from '@theme';
import { Tab, Tabs } from 'rspress/theme';

# Custom Framework Integration

> Highly WIP.

Lynx is "framework-agnostic".

:::info As we said in our blog:

> _However, Lynx isn't limited to React._ In fact, other frameworks already represent roughly half of Lynx's overall usage, demonstrating its neutrality in hosting different flavors.

> Not only is the core engine of Lynx framework-agnostic, but it's also agnostic to host platforms and rendering backends.

Go to [this blog](https://lynxjs.org/blog/lynx-unlock-native-for-more.html#craft-designs-with-markups-and-css-as-usual) for more details.

:::

This means you can integrate other frameworks. In fact, other frameworks already represent roughly half of Lynx's overall usage, demonstrating its neutrality in hosting different flavors.

Lynx may open source other frameworks later (you can follow their progress [here](https://github.com/lynx-family/lynx/issues/144#issuecomment-2705466656)), but it may not include all the frameworks you want. If you want to integrate a framework that Lynx does not support or has no plans to support, you can do it yourself.

## What will we build?

This document will show you how to integrate a framework to Lynx by **building a minimal framework under Lynx**.

You can also **jump directly to [Real Framework Integration](#real-framework-integration)**, which uses examples from a real framework for more practical demonstrations.

You need some prerequisites:

- A basic development environment. This means you need to install Node.js and npm.

- Familiarity with web development.

- Familiarity with writing Webpack-style configuration. Similar to building an application on the web, you need to configure the build tool. In this guide we will use [Rspack](https://rspack.dev/), which can be configured in the same way as Webpack.

- Understand the basic concepts of Lynx. It is recommended that you have read the [Quick Start](/guide/start/quick-start).

## How to generate an App Bundle

You may have noticed that Lynx needs to load a file like `dist/main.lynx.bundle`. This is a binary file that includes two Lynx runtime script files and CSS files - your application code is in it.

<Details title="@lynx-js/tasm package responsibilities">

Essentially, the App Bundle is generated by the npm package `@lynx-js/tasm`. This package is the encoder of Lynx App Bundle, which encodes your application code into Lynx's binary format.

You can refer to how Rspeedy [uses the `@lynx-js/tasm` encoder](https://github.com/lynx-family/lynx-stack/blob/5e01cef366a20d48b430b11eedbf9e5141f316a2/packages/webpack/template-webpack-plugin/src/LynxEncodePlugin.ts#L202).

</Details>

With Rspack, you can use the `LynxEncodePlugin` and `LynxTemplatePlugin` plugins provided by the npm package `@lynx-js/template-webpack-plugin` to generate this file.

If you like "Show me the code", the following Playground is ready for you:

<Go
  example="vanilla-lynx-bundle"
  highlight="{40-44}"
  defaultFile="rspack.config.js"
  defaultEntryFile="dist/vanilla.lynx.bundle"
  entry="rspack.config.js"
/>

---

But if you want to build it step by step, please follow the steps below:

<Steps>

### Create a project

Just like on the Web, to get a minimal webpage, you don't need some big and complete frameworks or toolchains, often just a build tool like Webpack is enough. Here we use Rspack.

Please create a new directory, we recommend calling it `vanilla-lynx-bundle`, and then install the following dependencies:

<PackageManagerTabs command="add -D @rspack/core @rspack/cli" />

You also need to create a `rspack.config.js` file to configure Rspack.

```js filename=rspack.config.js
/**
 * @type {import("@rspack/core").Configuration}
 */
const config = {
  // We will complete this configuration later
};
export default config;
```

### Configure Rspack

Like we will build on the Web, you need to configure Rspack to tell it how to build your application. This usually starts with the entry file.

Here we will add two entry files because we need to build two different files, one for the [main thread](guide/spec.html#main-thread-or-lynx-main-thread) and one for the [background thread](guide/spec.html#background-thread-aka-off-main-thread).

<Details title="Layers?">

Using two [layers](https://webpack.js.org/configuration/module/#rulelayer) to build the main thread and background thread of Lynx respectively will make it easier to add more complex build configurations later.

Currently, Rspack needs to be configured with `experiments.layers` to enable this feature.

</Details>

```js filename=rspack.config.js {10-19,21}
const LAYERS = {
  MAIN_THREAD: 'main-thread',
  BACKGROUND: 'background',
};
const NAME = 'vanilla';
/**
 * @type {import("@rspack/core").Configuration}
 */
const config = {
  entry: {
    [`${NAME}@main-thread`]: {
      layer: LAYERS.MAIN_THREAD,
      import: './src/index.main-thread.js',
    },
    [`${NAME}@background`]: {
      layer: LAYERS.BACKGROUND,
      import: './src/index.js',
    },
  },
  experiments: {
    layers: true,
  },
};
export default config;
```

### Add entry files

Obviously, the above configuration points to two non-existent files, you need to create them. Create two entry files in the `src` directory:

<Tabs
  defaultValue="src/index.main-thread.js"
  values={[
    { label: 'Main thread', value: 'src/index.main-thread.js' },
    { label: 'Background thread', value: 'src/index.js' },
  ]}>
  <Tab value="src/index.main-thread.js">

```jsx title="src/index.main-thread.js"
console.log('Hello, Lynx');
```

  </Tab>
  <Tab value="src/index.js">

```jsx title="src/index.js"
console.log('Hello, Lynx');
```

  </Tab>
</Tabs>

Now, if you execute `npx rspack build`, you should be able to see two files in the `dist` directory. Lynx cannot run these files directly.

### Generate App Bundle file

We need to use the `LynxEncodePlugin` and `LynxTemplatePlugin` plugins provided by `@lynx-js/template-webpack-plugin` to generate the App Bundle file.

First, install this npm package:

<PackageManagerTabs command="add -D @lynx-js/template-webpack-plugin" />

Then, modify the `rspack.config.js` file:

```js filename=rspack.config.js {1,9-13,20}
import { LynxEncodePlugin, LynxTemplatePlugin } from '@lynx-js/template-webpack-plugin';
...
/**
 * @type {import("@rspack/core").Configuration}
 */
const config = {
  ...
  plugins: [
    new LynxEncodePlugin({}),
    new LynxTemplatePlugin({
      filename: `${NAME}.lynx.bundle`,
      intermediate: NAME,
    }),
    (compiler) => {
      compiler.hooks.thisCompilation.tap('MarkMainThreadWebpackPlugin', (compilation) => {
          compilation.hooks.processAssets.tap('MarkMainThreadWebpackPlugin', () => {
              const asset = compilation.getAsset(`${NAME}@main-thread.js`);
              compilation.updateAsset(asset.name, asset.source, {
                ...asset.info,
                'lynx:main-thread': true,
              });
            },
          );
        },
      );
    },
  ],
  ...
};
```

In addition to `LynxEncodePlugin` and `LynxTemplatePlugin`, we also added a plugin to mark script files running on the main thread.
The `'lynx:main-thread': true` information it adds will be used to distinguish whether the script file should be run on the main thread or the background thread.

At this point, you can run `npx rspack build` again and see the `vanilla.lynx.bundle` file in the `dist` directory.
You have successfully built a Lynx App Bundle. However, there is no valid content in this bundle, so Lynx cannot run it.
If you open this file with LynxExplorer (get it in [this document](guide/start/quick-start.html)), you will see a blank page and some error messages.

</Steps>

## Run the App Bundle

Now let's focus on the running effect of this App Bundle.

We will improve the entry files of the two threads so that Lynx can run them correctly and draw the UI. At the same time, we will add CSS to add styles to our UI. Here is the final effect:

<Go
  example="vanilla-lynx-bundle"
  highlight="{3}"
  defaultFile="src/index.main-thread.js"
  defaultEntryFile="dist/vanilla.lynx.bundle"
  img={`${window.location.origin}/lynx-examples/vanilla-lynx-bundle/assets/preview.png`}
  entry={/(^src\/|rspack\.config\.js)/}
/>

---

Please follow our steps and complete the build step by step:

<Steps>

### Add Called-by-Native functions

Lynx interacts with your application by calling some functions on `globalThis`. These functions are called Called-by-Native functions.

We will call Lynx's [Element PAPI](api/engine/element-api.html) in the `renderPage` function of the main thread to draw some UI.
In the background thread, there is also a similar function `initBundle`. Since the background thread cannot directly operate the UI, we simply print some information.

<Tabs
  defaultValue="src/index.main-thread.js"
  values={[
    { label: 'Main thread', value: 'src/index.main-thread.js' },
    { label: 'Background thread', value: 'src/index.js' },
  ]}>
  <Tab value="src/index.main-thread.js">

```jsx title="src/index.main-thread.js" {2-14}
globalThis.renderPage = function () {
  const page = __CreatePage('0', 0);
  const pageId = __GetElementUniqueID(page);
  const container = __CreateView(pageId);
  __AddClass(container, 'container');
  const logo = __CreateImage(pageId);
  __SetAttribute(logo, 'src', 'https://github.com/lynx-family.png');
  __AddClass(logo, 'logo');
  const slogan = __CreateText(pageId);
  __AddClass(slogan, 'slogan');
  __SetAttribute(slogan, 'text', 'Lynx: Unlock Native for More');
  __AppendElement(page, container);
  __AppendElement(container, logo);
  __AppendElement(container, slogan);
};
globalThis.updatePage = function () {};
globalThis.processData = function () {};
```

  </Tab>
  <Tab value="src/index.js">

```jsx title="src/index.js" {2}
globalThis.initBundle = () => {
  console.log('Lynx: Unlock Native for More');
};
```

  </Tab>
</Tabs>

### Add CSS support to Rspack

Rspack provides CSS support out of the box. You just need to configure `experiment.css` to `true` and you are all set.

The `LynxTemplatePlugin` plugin will "collect" your CSS files and add them to the App Bundle.

```js filename=rspack.config.js {5}
const config = {
  ...
  experiments: {
    ...
    css: true,
  },
};
```

### Write styles

We also need to add some styles to the UI. We have already written the CSS file for you. Please create an `index.css` file in the `src` directory and copy the following content into it:

```css filename=src/index.css
.container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  gap: 16rpx;
}
.logo {
  width: 128rpx;
  height: 128rpx;
  border-radius: 64rpx;
}
.slogan {
  color: #333;
  font-weight: bold;
}
```

Of course, don't forget to import this CSS file in the entry file. Be careful not to import the same CSS file in two entry files at the same time, otherwise it will cause CSS duplication.

```jsx filename=src/index.main-thread.js {1}
import './index.css';

...
```

### Build and Run

Now, you can execute `npx rspack build` again, and then you can see the `vanilla.lynx.bundle` file in the `dist` directory.
Open this file with LynxExplorer, and you will see a page with Lynx Logo and Slogan.

</Steps>

## Real-framework Integration \{#real-framework-integration}

:::tip

This section assumes you have read the above instructions and focuses on showing code.

You may be confused about a particular code. If so, reading the above instructions may help.

:::

:::caution Disclaimer

These frameworks are not currently officially supported by Lynx and cannot represent the actual performance, development experience, and user experience of Lynx. The integration of these frameworks may have some limitations or may change in future versions.

The following code is for demonstration purposes only. It is not designed to be a complete framework. Its performance and compatibility cannot be guaranteed and should not be used in production.

:::

Please refer to the code directly:

- [lynx-examples/examples/with-solidjs](https://github.com/lynx-family/lynx-examples/tree/main/examples/with-solidjs): Using SolidJS under Lynx
- (More Examples are WIP...)
